<!DOCTYPE html>
<html>
<head>
    <title>Jared's Chat Client</title>
</head>
<link rel="stylesheet" type="text/css" href="style.css">
<body>
    <p class="alignright">Username:
        <button class="alignright" type="button">Sign out</button>
    </p>
    <div style="clear: both;"></div>
    <textarea cols="70" rows="20" id="messagesbox"></textarea>
    <textarea cols="20" rows="20">
    username1
    user2
    me
    </textarea>
    <form action="#" id="messageform">
        Broadcast Message:
        <br />
        <input type="text"  size="90" id="messageinput" required>
        <input type="submit" id='submitbroadcast' value="Broadcast">
        <button type="button" id="updateusersbutton">Update Users</button>
    </form>

    <script type="text/javascript">
        var connection = new WebSocket('ws://127.0.0.1:8787');
        var username = window.location.search.split('=').pop().toLowerCase();
        var form = document.getElementById('messageform');
        var messagefield = document.getElementById('messageinput');
        var broadcastBtn = document.getElementById('submitbroadcast');
        var updateusersbtn = document.getElementById('updateusersbutton');
        var messages = document.getElementById('messagesbox');

        form.onsubmit = function(e){
            e.preventDefault();
            //console.log("Logging in as: " + username.value.toLowerCase());
            var message = messagefield.value;
            //connection.send("BROADCAST " + username + "\n" + message);
            connection.send("BROADCAST \n" +  message);
            messages.innerHTML += username + ': ' + message + '\r\n';
            //connection.send(message);
            messagefield.value = '';
        }

        updateusersbtn.onclick = function(e){
            e.preventDefault();
            connection.send("WHO HERE " + username);
            //connection.send("SEND " + username + "fred" + "\nthis is the message");
        }

        /*window.onload = function() {

        };*/

        connection.onopen = function(){
            /*Send a small message to the console once the connection is established */
            console.log('Connection open!');
            console.log("Username is: " + username);
            console.log();
            connection.send("ME IS " + username);
        }

        connection.onerror = function(error){
            alert("An error has occured");
            console.log('Websocket error: ' + error);
        }

        connection.onmessage = function(e){
           var server_message = e.data;
           console.log("MESSAGE: " + server_message);
           messages.innerHTML += server_message + '\r\n';
        }

        /* Connection is refused or closed */
        connection.onclose = function(){
            console.log('Connection closed');
        }

    </script>

</body>
</html>
